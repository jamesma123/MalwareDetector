import feedparser
import requests
import tarfile
import os
import time
import openai

# Set your OpenAI API key
openai.api_key = '***'

def download_and_extract_sdist(url):
    with requests.get(url, stream=True) as response:
        response.raise_for_status()
        filename = url.split('/')[-1]
        with open(filename, 'wb') as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
    return filename

def extract_code_from_sdist(filename):
    with tarfile.open(filename, 'r:gz') as tar:
        tar.extractall()
    os.remove(filename)
    print("Code extracted.")

def scan_for_malware(code):
    response = openai.Completion.create(
        engine="text-davinci-003",
        prompt=f"Scan the following Python code for malware:\n\n{code}\n\nPotential malware:",
        max_tokens=100,
        temperature=0.5
    )
    return response.choices[0].text.strip()

url = 'https://pypi.org/pypi/requests/json'
resp = requests.get(url)
status = resp.status_code
data = resp.json()
releases = data.get('releases')

parsed = feedparser.parse('https://pypi.org/rss/packages.xml')
xparsed = feedparser.parse('https://pypi.org/rss/updates.xml')

for entry in xparsed.entries:
    title_parts = entry.title.split(' ')
    if len(title_parts) >= 2:
        name = title_parts[0]
        version = title_parts[1]

        # Send name and version to requests API
        url = f'https://pypi.org/pypi/{name}/{version}/json'
        resp = requests.get(url)
        if resp.status_code == 200:
            metadata = resp.json()
            # Process metadata as needed
            print("Name:", name)
            print("Version:", version)
            print("Metadata:", metadata)
            print()

            # Download sdist
            sdist_url = None
            for release in metadata['urls']:
                if release['packagetype'] == 'sdist':
                    sdist_url = release['url']
                    break
            
            if sdist_url:
                sdist_filename = download_and_extract_sdist(sdist_url)
                extract_code_from_sdist(sdist_filename)
                
                # Read and scan the extracted code for malware
                with open('extracted_code.py', 'r') as code_file:
                    extracted_code = code_file.read()
                    potential_malware = scan_for_malware(extracted_code)
                    if potential_malware:
                        print("Potential Malware Detected:")
                        print(potential_malware)
            else:
                print("No sdist found for the release.")
        
        # Introduce a 5-second delay
        time.sleep(5)
